<!DOCTYPE html>
<html lang="id" xmlns:th="http://www.thymeleaf.org" data-theme="light">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title th:text="'Chat dengan ' + ${data.receiver.fullName}">Live Chat</title>

    <link rel="stylesheet" th:href="@{/css/output.css}" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
</head>

<body class="bg-base-100 text-base-content flex flex-col min-h-screen font-sans w-screen">
    <div th:replace="fragment/navbar :: navbar"></div>

    <div class="hidden" id="userId" th:attr="data-userId=${data.currentUser.id}"></div>
    <div class="hidden" id="receiverId" th:attr="data-receiverId=${data.receiver.id}"></div>
    <div class="hidden ring-success"></div>
    <div class="hidden ring-base-200"></div>

    <!-- ðŸ§  Header -->
    <header class="navbar bg-base-100 shadow-md border-b border-base-200 sticky top-16 z-40">
        <div class="flex items-center gap-3 px-4 py-2 w-full">
            <button class="btn btn-ghost btn-circle hover:bg-base-300">
                <a th:href="@{/live-chat}">
                    <svg height="28" viewBox="0 0 512 512" width="28">
                        <polygon points="352,128.4 319.7,96 160,256 319.7,416 352,383.6 224.7,256" />
                    </svg>
                </a>
            </button>

            <div id="receiverAvatar" class="avatar relative">
                <div class="w-10 md:w-12 rounded-full ring ring-base-200 ring-offset-base-100 ring-offset-2">
                    <img th:src="@{${#strings.isEmpty(data.receiver.profilePicture) ? '/img/default.jpg' : '/uploads/' + data.receiver.profilePicture}}"
                        alt="Profile Picture" />
                </div>
            </div>

            <div class="flex flex-col">
                <h1 class="font-bold text-base md:text-lg" th:text="${data.receiver.fullName}">Nama Lengkap</h1>
                <p class="text-xs text-neutral/80" th:text="'@' + ${data.receiver.username}">@username</p>
            </div>
        </div>
    </header>

    <!-- ðŸ—¨ï¸ Chat messages -->
    <main id="chat-messages"
        class="flex-1 overflow-y-auto bg-base-100 p-4 md:p-6 flex flex-col gap-3 scroll-smooth mt-18">
        <th:block th:with="lastDate = ''">
            <div th:each="chat, iterStat : ${data.chatHistory}">
                <th:block th:with="currentDateYMD = ${#temporals.format(chat.timeStamp, 'yyyy-MM-dd')}">

                    <!-- DATE SEPARATOR -->
                    <div th:if="${iterStat.first || !#strings.equals(currentDateYMD, data.chatHistory[iterStat.index - 1].timeStamp.format(T(java.time.format.DateTimeFormatter).ofPattern('yyyy-MM-dd')))}"
                        class="flex justify-center my-2 chat-date-separator">
                        <div class="badge badge-lg bg-base-300 text-base-content/80 shadow-md"
                            th:attr="data-date=${currentDateYMD}">
                            <span th:text="${#temporals.format(chat.timeStamp, 'EEEE, d MMM yyyy')}">
                                Tanggal
                            </span>
                        </div>
                    </div>

                    <!-- CHAT WRAPPER -->
                    <div class="chat" th:classappend="${chat.ownMessage} ? ' chat-end' : ' chat-start'">

                        <div class="chat-bubble relative shadow-lg max-w-xs md:max-w-md"
                            th:classappend="${chat.ownMessage} ? ' bg-neutral text-neutral-content' : ' bg-base-300 text-base-content'">

                            <!-- DELETE BUTTON (hanya pesan sendiri) -->
                            <!-- DELETE BUTTON (hanya pesan sendiri) -->
                            <button th:if="${chat.ownMessage}" th:attr="data-id=${chat.chatId}"
                                class="absolute -top-3 -right-3 bg-red-600 text-red-50 p-2 rounded-full shadow-md active:scale-95 transition"
                                title="Delete message">

                                <!-- SVG DELETE ICON -->
                                <svg viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                                    class="pointer-events-none">
                                    <rect fill="none" height="256" width="256" />
                                    <line fill="none" stroke="currentColor" stroke-linecap="round"
                                        stroke-linejoin="round" stroke-width="16" x1="216" x2="40" y1="56" y2="56" />
                                    <line fill="none" stroke="currentColor" stroke-linecap="round"
                                        stroke-linejoin="round" stroke-width="16" x1="104" x2="104" y1="104" y2="168" />
                                    <line fill="none" stroke="currentColor" stroke-linecap="round"
                                        stroke-linejoin="round" stroke-width="16" x1="152" x2="152" y1="104" y2="168" />
                                    <path d="M200,56V208a8,8,0,0,1-8,8H64a8,8,0,0,1-8-8V56" fill="none"
                                        stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                        stroke-width="16" />
                                    <path d="M168,56V40a16,16,0,0,0-16-16H104A16,16,0,0,0,88,40V56" fill="none"
                                        stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                                        stroke-width="16" />
                                </svg>

                            </button>

                            <!-- END DELETE BUTTON -->

                            <!-- PRODUCT PREVIEW -->
                            <th:block th:if="${chat.product != null}">
                                <div
                                    class="mt-2 rounded-xl border border-base-300 bg-base-200 p-3 shadow-md max-w-xs md:max-w-md">
                                    <div class="flex gap-3 items-center">
                                        <img th:src="@{'/uploads/' + ${chat.product.thumbnailUrl}}"
                                            class="w-20 h-20 object-cover rounded-lg" alt="thumbnail" />

                                        <div class="flex flex-col">
                                            <div class="font-semibold text-base-content" th:text="${chat.product.name}">
                                                Nama Produk
                                            </div>

                                            <div class="text-sm opacity-100 text-success"
                                                th:text="'Rp' + ${#numbers.formatInteger(chat.product.price, 3, 'POINT')}">
                                                Rp10.000
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </th:block>
                            <!-- END PRODUCT PREVIEW -->

                            <!-- message text -->
                            <div th:text="${chat.text}"></div>

                            <!-- footer -->
                            <div class="chat-footer mt-1 text-xs opacity-70 text-end"
                                th:text="${#temporals.format(chat.timeStamp, 'HH:mm')}">
                                12:30
                            </div>

                        </div>
                    </div>

                </th:block>
            </div>
        </th:block>
    </main>



    <div id="product-preview" class="w-full bg-base-200 border border-base-300 rounded-lg p-3 mb-2 hidden relative">
        <button id="close-preview"
            class="btn btn-xs btn-circle absolute top-2 right-2 border-base-300 hover:bg-error hover:text-white">
            âœ•
        </button>

        <div class="flex gap-3 items-start">
            <img id="preview-image" src="" alt="thumbnail"
                class="w-16 h-16 rounded-lg object-cover border border-base-300" />

            <div class="flex flex-col">
                <p id="preview-name" class="font-semibold"></p>
                <p id="preview-price" class="text-sm text-neutral"></p>
            </div>
        </div>
    </div>

    <footer class="bg-base-100 border-t border-base-200 p-3 md:p-4 sticky bottom-0 z-10">
        <form id="chat-form" class="flex items-center gap-3">

            <!-- INPUT CHAT -->
            <input type="text" id="chat-input" placeholder="Ketik pesan..."
                class="input input-bordered input-md w-full rounded-full focus:outline-none focus:ring-2 focus:ring-neutral"
                autocomplete="off" />

            <!-- ADD PRODUCT BTN -->
            <button type="button" id="open-product-modal"
                class="btn btn-square btn-neutral text-neutral-content hover:bg-primary min-w-10">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" stroke="currentColor"
                    fill="none" stroke-width="2">
                    <path d="M12 5v14M5 12h14" />
                </svg>
            </button>

            <!-- SEND BTN -->
            <button type="submit"
                class="btn btn-neutral btn-circle text-neutral-content hover:bg-primary fill-neutral p-2">
                <svg enable-background="new 0 0 512 512" height="28" viewBox="0 0 512 512" width="28">
                    <path
                        d="M189.547,324.346l87.616,176.304l223.917-490L11.137,245.793L189.547,324.346z M194.754,305.243l-136.77-60.216L433.599,64.761L194.754,305.243z M276.436,455.383l-67.787-136.416L449.62,76.36L276.436,455.383z"
                        fill="#ffffff" />
                </svg>
            </button>

        </form>
    </footer>

    <!-- Modal / Drawer untuk pilih produk -->
    <dialog id="product-modal" class="modal">
        <div class="modal-box max-w-md">
            <h3 class="font-bold text-lg mb-3">Pilih Produk</h3>
            <div id="product-list" class="flex flex-col gap-3">
                <!-- JS akan render produk di sini -->
            </div>
            <div class="modal-action">
                <button class="btn" id="close_modal_product" onclick="productModal.close()">Tutup</button>
            </div>
        </div>
    </dialog>



    <input type="hidden" id="userId" th:value="${data.currentUser.id}" />
    <input type="hidden" id="receiverId" th:value="${data.receiver.id}" />


    <script th:inline="javascript">
        /*[+
        var productData = {
            id: '[(${initialProduct.id})]',
            name: '[(${initialProduct.name})]',
            price: [(${initialProduct.price})],
            thumbnailUrl: '[(${initialProduct.thumbnailUrl})]'
        };
        +]*/
        window.__initial_product = productData;
        console.log("model : ", window.__initial_product);
    </script>

    <script th:src="@{/js/privateChatPage.js}" defer></script>
</body>

</html>