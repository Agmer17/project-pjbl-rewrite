<!DOCTYPE html>
<html lang="id" xmlns:th="http://www.thymeleaf.org" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Chat</title>
    <link rel="stylesheet" th:href="@{/css/output.css}">
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        html,
        body {
            height: 100%;
        }
    </style>
</head>

<body class="bg-white text-neutral min-h-screen h-full flex flex-col items-center sm:py-10 font-sans">

    <div th:replace="fragment/navbar :: navbar" class="hidden sm:block"></div>


    <main
        class="w-full sm:w-11/12 max-w-2xl bg-white border-none sm:border border-neutral-200 sm:rounded-2xl shadow-none sm:shadow-xl overflow-hidden mt-0 sm:mt-10 mb-0 sm:mb-22 flex flex-col flex-grow">
        <div class="px-4 sm:px-6 py-4 border-b border-neutral-200 flex justify-between items-center flex-shrink-0">
            <h1 class="text-xl sm:text-2xl font-bold">Livechat History</h1>
        </div>

        <div id="chatListContainer" class="flex flex-col divide-y divide-neutral-200 overflow-y-auto flex-grow"
            th:if="${!#lists.isEmpty(chatList)}">

            <div th:each="chat : ${chatList}"
                class="chat-item p-4 hover:bg-neutral-50 transition cursor-pointer flex items-center gap-3"
                th:attr="data-id=${chat.userId},onclick=|window.location.href='@{/live-chat/with/{id}(id=${chat.userId})}'|">

                <img th:src="@{${#strings.isEmpty(chat.profilePicture) ? '/img/default.jpg' : '/uploads/' + chat.profilePicture}}"
                    alt="Profile Picture"
                    class="w-12 h-12 rounded-full object-cover border border-neutral-300 shadow-sm flex-shrink-0" />

                <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-center mb-0.5">
                        <div class="w-full flex gap-4">
                            <h2 class="font-semibold truncate" th:text="${chat.fullName}">Nama</h2>
                            <div class="badge badge-warning font-bold flex-shrink-0"
                                th:text="${#strings.toLowerCase(chat.role)}"></div>
                        </div>
                        <p class="text-sm text-neutral-500 chat-time flex-shrink-0"
                            th:if="${chat.lastMessageTime != null}"
                            th:text="${#temporals.format(chat.lastMessageTime, 'HH:mm')}">12:00</p>
                    </div>

                    <p class="text-sm text-neutral-600 truncate chat-preview"
                        th:text="${chat.lastMessage != null ? chat.lastMessage : 'Belum ada percakapan'}"
                        th:classappend="${chat.lastMessage == null} ? 'italic text-neutral-400' : ''">
                        Pesan terakhir...
                    </p>
                </div>
            </div>
        </div>

        <div th:if="${#lists.isEmpty(chatList)}" class="text-center py-12 text-neutral-500 flex-grow">
            Belum ada admin tersedia ðŸ˜…
        </div>
    </main>

    <div th:replace="fragment/navbar :: bottombar('chat')"></div>

    <script th:inline="javascript">
        const currentUserId = /*[[${userId}]]*/ null;

        const socket = new SockJS('/ws');
        const stompClient = Stomp.over(socket);
        const chatListContainer = document.getElementById('chatListContainer');

        stompClient.connect({}, () => {
            console.log('âœ… Connected to WebSocket');

            stompClient.subscribe(`/user/${currentUserId}/queue/messages`, (payload) => {
                const message = JSON.parse(payload.body);
                console.log('ðŸ“© Pesan baru:', message);
                updateChatList(message);
            });
        });

        function updateChatList(message) {
            const { sender, text } = message;

            const chatItem = document.querySelector(`.chat-item[data-id="${sender}"]`);
            if (chatItem) {
                const preview = chatItem.querySelector('.chat-preview');
                const time = chatItem.querySelector('.chat-time');

                preview.textContent = text;
                time.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                // pindahkan ke atas
                chatListContainer.prepend(chatItem);
            } else {
                console.log("ðŸ”„ Chat baru belum ada di list â€” mungkin admin baru, reload halaman nanti.");
            }
        }
    </script>
</body>

</html>