<!DOCTYPE html>
<html lang="id" xmlns:th="http://www.thymeleaf.org" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${product.name}"></title>
    <link th:href="@{/css/output.css}" rel="stylesheet" />
</head>

<body class="font-sans bg-white min-h-screen text-neutral">
    <input type="hidden" id="productId" th:value="${product.id}">


    <!-- Navbar -->
    <div th:replace="fragment/navbar :: navbar"></div>
    <div id="toast-container" class="toast toast-top toast-end z-50"></div>
    <dialog id="confirmDeleteModal" class="modal modal-bottom sm:modal-middle">
        <div class="modal-box bg-base-100 shadow-2xl border border-neutral/20 rounded-2xl">
            <h3 class="font-bold text-lg text-error mb-2 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-error" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
                Konfirmasi Penghapusan
            </h3>
            <p class="text-sm text-neutral-content mb-6">
                Apakah kamu yakin ingin menghapus review ini? Tindakan ini tidak bisa dibatalkan.
            </p>

            <div class="modal-action flex flex-col sm:flex-row gap-3 justify-end">
                <button id="confirmDeleteBtn"
                    class="btn btn-error text-white w-full sm:w-auto hover:brightness-110 transition-all">
                    Hapus
                </button>
                <button id="cancelDeleteBtn"
                    class="btn w-full sm:w-auto border-neutral/30 hover:bg-base-200 transition-all">
                    Batal
                </button>
            </div>
        </div>
    </dialog>

    <!-- Layout utama -->
    <div class="flex flex-col lg:flex-row mt-16 min-h-screen bg-base-100">
        <!-- Sidebar -->
        <th:block th:if="${admin}">
            <div th:replace="fragment/navbar :: sidebar('products')"></div>
        </th:block>
        <main class="bg-base-100 min-h-screen flex flex-col gap-12 p-6 md:p-10 w-full mb-20">
            <div class="w-full flex items-start justify-between">
                <a th:href="@{${admin} ? '/admin/products/' : '/products/'}"
                    class="inline-flex items-center gap-2 mb-6 text-sm font-medium text-neutral hover:text-primary transition-colors group">
                    <div
                        class="w-10 h-10 rounded-full border border-neutral/30 group-hover:border-primary flex items-center justify-center transition-all group-hover:scale-110">
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 12H5M12 19l-7-7 7-7" />
                        </svg>
                    </div>
                    <span th:text="@{${admin} ? 'kembali ke dahsboard' : 'kembali ke product'}" class="text-lg"></span>
                </a>
                <a th:href="@{/admin/products/edit/{id}(id=${product.id})}" th:if="${admin}"
                    class="btn btn-square btn-neutral btn-outline tooltip tooltip-left" data-tip="Edit Produk">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                </a>
            </div>

            <div class="w-full mx-auto flex flex-col lg:flex-row gap-12 items-start">
                <div class="w-full lg:w-1/2 space-y-4">
                    <div class="relative w-full overflow-hidden rounded-3xl shadow-lg border border-base-200 group">
                        <div class="carousel w-full">
                            <div th:each="img, iterStat : ${product.images}" th:id="'slide' + ${iterStat.index}"
                                class="carousel-item relative w-full flex justify-center items-center">
                                <img th:src="@{'/uploads/' + ${img.imageFileName}}" alt="Product Image"
                                    class="object-cover w-full h-[280px] sm:h-[400px] lg:h-[500px] xl:h-[520px] transition-transform duration-500 group-hover:scale-[1.01]" />
                                <div class="absolute inset-x-0 top-1/2 flex justify-between px-6 -translate-y-1/2">
                                    <a th:with="prevIndex = ${iterStat.index == 0 ? #lists.size(product.images) - 1 : iterStat.index - 1}"
                                        th:href="'#slide' + ${prevIndex}"
                                        class="btn btn-circle btn-sm md:btn-md bg-base-100/70 hover:bg-primary text-neutral border-none shadow-md transition-all duration-300">‚ùÆ</a>
                                    <a th:with="nextIndex = ${(iterStat.index + 1) % #lists.size(product.images)}"
                                        th:href="'#slide' + ${nextIndex}"
                                        class="btn btn-circle btn-sm md:btn-md bg-base-100/70 hover:bg-primary text-neutral border-none shadow-md transition-all duration-300">‚ùØ</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-2 mt-2 overflow-x-auto pb-2 no-scrollbar justify-center">
                        <div th:each="img, iter : ${product.images}">
                            <a th:href="'#slide' + ${iter.index}">
                                <img th:src="@{'/uploads/' + ${img.imageFileName}}" alt="Thumbnail"
                                    class="w-16 h-16 md:w-20 md:h-20 flex-shrink-0 rounded-xl object-cover border-2 border-transparent hover:border-primary transition-all duration-300 cursor-pointer" />
                            </a>
                        </div>
                    </div>
                </div>

                <div class="w-full lg:w-1/2 space-y-8">
                    <div class="flex flex-col gap-2">
                        <a th:href="@{/category/{id}(id=${product.category.id})}"
                            class="badge badge-lg badge-neutral text-base-100 hover:brightness-110 transition-all"
                            th:text="${product.category.name}">
                            Kategori
                        </a>
                        <p class="text-xs text-neutral/70"
                            th:text="'Dibuat pada: ' + ${#temporals.format(product.createdAt, 'dd MMMM yyyy')}"></p>
                    </div>

                    <div>
                        <h1 class="text-4xl md:text-5xl font-extrabold text-neutral leading-tight tracking-tight 
               break-words whitespace-normal">
                            <span th:text="${product.name}">Nama Produk</span>
                        </h1>
                    </div>

                    <div class="border-t border-base-200 pt-4">
                        <p class="text-3xl md:text-4xl font-black text-neutral flex items-center gap-2">
                            <span class="text-lg font-semibold">IDR</span>
                            <span th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')}"></span>
                        </p>
                    </div>

                    <div>
                        <h2 class="text-lg font-semibold mb-2 text-neutral-800">Deskripsi Layanan</h2>
                        <p class="text-neutral-700 leading-relaxed text-base" th:text="${product.desc}">
                            Deskripsi produk akan tampil di sini.
                        </p>
                    </div>

                    <div class="pt-4" th:if="${!admin}">
                        <button id="btnOpenAdminModal" class="btn btn-lg w-full bg-neutral text-base-100 hover:bg-neutral/90 rounded-2xl 
           transition-all duration-300 shadow-md hover:shadow-xl flex items-center gap-2 justify-center">

                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 
                   2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 4v-4z" />
                            </svg>

                            Konsultasikan Paket Ini
                        </button>

                        <p class="text-center text-xs text-neutral/60 mt-2">
                            Hubungi admin untuk detail dan penawaran.
                        </p>
                    </div>
                </div>
            </div>

            <div th:if="${#lists.size(product.images) > 1}" class="mt-16">
                <h2 class="text-2xl font-extrabold mb-8 text-neutral border-b border-base-200 pb-3">
                    üìÇ Portfolio & Hasil Kerja
                </h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6">
                    <div th:each="img : ${product.images}"
                        class="relative rounded-2xl overflow-hidden shadow-md group cursor-pointer">
                        <img th:src="@{'/uploads/' + ${img.imageFileName}}" alt="Gallery Image"
                            class="object-cover w-full h-48 md:h-64 aspect-square transition-transform duration-500 ease-in-out group-hover:scale-105" />
                    </div>
                </div>
            </div>

            <div class="mt-16 max-w-5xl mx-auto w-full">

                <div class="w-full flex justify-between">
                    <h2 class=" text-xl md:text-2xl font-extrabold mb-8 text-neutral border-b border-base-200 pb-3">
                        ‚≠ê Ulasan Pelanggan
                    </h2>
                    <a th:href="@{/reviews/details/{id}(id=${product.id})}"
                        class="text-warning btn btn-warning btn-circle btn-outline hover:text-white">
                        <svg height="24" id="Layer_1" style="enable-background:new 0 0 512 512;" version="1.1"
                            viewBox="0 0 512 512" width="24" xml:space="preserve" xmlns="http://www.w3.org/2000/svg"
                            xmlns:xlink="http://www.w3.org/1999/xlink" stroke="currentColor" fill="currentColor">
                            <polygon
                                points="160,128.4 192.3,96 352,256 352,256 352,256 192.3,416 160,383.6 287.3,256 " />
                        </svg>

                    </a>

                </div>

                <div th:if="${!#lists.isEmpty(reviews)}" th:with="totalReviews=${reviews.size()}">
                    <div class="card bg-base-100 shadow-lg border border-base-300 mb-8 rounded-3xl">
                        <div class="card-body p-6 md:p-10">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">

                                <div
                                    class="md:col-span-1 flex flex-col items-center md:items-start justify-center border-b md:border-b-0 md:border-r border-base-300 pb-6 md:pb-0 md:pr-8">
                                    <div class="text-6xl md:text-7xl font-extrabold text-gray-900 mb-2"
                                        th:text="${#numbers.formatDecimal(avg,1,1)}">4.8</div>
                                    <div class="flex items-center gap-1 mb-2">
                                        <span th:each="i : ${#numbers.sequence(1,5)}"
                                            th:classappend="${avg >= i ? 'text-amber-500' : 'text-gray-300'}"
                                            class="text-2xl md:text-3xl">‚òÖ</span>
                                    </div>
                                    <div class="text-sm md:text-base text-gray-600"
                                        th:text="${totalReviews} + ' ulasan'">
                                        286 ulasan</div>
                                </div>

                                <div class="md:col-span-2 space-y-4">
                                    <div th:each="ratingLevel : ${#numbers.sequence(5,1)}"
                                        th:with="count=${reviewRatingCount.get(ratingLevel) ?: 0L}">
                                        <div class="flex items-center gap-3">
                                            <span class="text-sm md:text-base text-gray-700 w-6"
                                                th:text="${ratingLevel}">5</span>
                                            <span class="text-amber-500 text-sm md:text-base">‚òÖ</span>
                                            <progress class="progress progress-warning h-2 flex-1"
                                                th:value="${totalReviews > 0 ? (count * 100.0 / totalReviews) : 0}"
                                                max="100"></progress>
                                            <span class="text-sm md:text-base text-gray-600 w-12 text-right"
                                                th:text="${count}">100</span>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

                <div th:if="${!#lists.isEmpty(reviews)}" class="space-y-6">

                    <th:block th:each="review, iterStat : ${reviews}">
                        <div th:if="${iterStat.index < 3}"
                            class="card bg-base-100 shadow-md border border-base-200 hover:shadow-xl transition-shadow duration-300 rounded-2xl">
                            <div class="card-body p-6 md:p-8">
                                <div class="flex items-start gap-4">

                                    <div class="avatar placeholder">
                                        <div class="w-12 h-12 rounded-full overflow-hidden"
                                            th:classappend="${review.user.profilePicture == null ? 'bg-gray-200 text-gray-600 flex items-center justify-center' : ''}">
                                            <img th:src="@{/uploads/{pic}(pic=${review.user.profilePicture})}"
                                                th:alt="${review.user.fullName}" class="w-full h-full object-cover"
                                                onerror="this.onerror=null; this.src='/img/default.jpg';" />
                                            <span th:if="${review.user.profilePicture == null}"
                                                class="text-lg font-semibold"
                                                th:text="${review.user.fullName != null ? #strings.substring(review.user.fullName,0,1) : 'U'}">A</span>
                                        </div>
                                    </div>

                                    <div class="flex-1 min-w-0">
                                        <div class="flex flex-row justify-between gap-2 mb-3">
                                            <div>
                                                <h3 class="font-semibold text-gray-900 text-lg md:text-xl"
                                                    th:text="${review.user.fullName}">Astolfo</h3>
                                                <p class="text-xs md:text-sm text-gray-500"
                                                    th:text="${#temporals.format(review.createdAt, 'dd MMM yyyy')}">04
                                                    Nov 2025
                                                </p>
                                            </div>

                                            <button
                                                class="btn btn-error btn-sm text-white flex items-center gap-1 rounded-full px-3 py-1 hover:opacity-90 transition-opacity"
                                                th:attr="data-id=${review.id}" onclick="deleteReview(this)"
                                                th:if="${admin}">
                                                <svg viewBox="0 0 448 512" width="18" height="18" fill="currentColor"
                                                    xmlns="http://www.w3.org/2000/svg">
                                                    <path
                                                        d="M432 80h-82.38l-34-56.75C306.1 8.827 291.4 0 274.6 0H173.4C156.6 0 141 8.827 132.4 23.25L98.38 80H16C7.125 80 0 87.13 0 96v16C0 120.9 7.125 128 16 128H32v320c0 35.35 28.65 64 64 64h256c35.35 0 64-28.65 64-64V128h16C440.9 128 448 120.9 448 112V96C448 87.13 440.9 80 432 80zM171.9 50.88C172.9 49.13 174.9 48 177 48h94c2.125 0 4.125 1.125 5.125 2.875L293.6 80H154.4L171.9 50.88zM352 464H96c-8.837 0-16-7.163-16-16V128h288v320C368 456.8 360.8 464 352 464zM224 416c8.844 0 16-7.156 16-16V192c0-8.844-7.156-16-16-16S208 183.2 208 192v208C208 408.8 215.2 416 224 416zM144 416C152.8 416 160 408.8 160 400V192c0-8.844-7.156-16-16-16S128 183.2 128 192v208C128 408.8 135.2 416 144 416zM304 416c8.844 0 16-7.156 16-16V192c0-8.844-7.156-16-16-16S288 183.2 288 192v208C288 408.8 295.2 416 304 416z" />
                                                </svg>
                                                <span class="hidden sm:inline">Hapus</span>
                                            </button>
                                        </div>

                                        <div class="flex items-center gap-1 mb-2">
                                            <span th:each="i : ${#numbers.sequence(1,5)}"
                                                th:classappend="${review.rating >= i ? 'text-amber-500' : 'text-gray-300'}"
                                                class="text-lg md:text-xl">‚òÖ</span>
                                            <span class="text-sm md:text-base font-medium text-gray-700 ml-1"
                                                th:text="${#numbers.formatDecimal(review.rating,1,1)}">4.0</span>
                                        </div>

                                        <p class="text-gray-700 leading-relaxed mb-4" th:text="${review.textReview}">
                                            Ulasan
                                        </p>
                                        <div th:switch="${review.status}">
                                            <span th:case="'APPROVED'"
                                                class="badge badge-success badge-sm">Approved</span>
                                            <span th:case="'PENDING'"
                                                class="badge badge-warning badge-sm">Pending</span>
                                            <span th:case="'REJECTED'"
                                                class="badge badge-error badge-sm">Rejected</span>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </th:block>

                    <div th:if="${#lists.size(reviews) > 3}" class="text-center pt-4">
                        <button class="btn btn-outline btn-neutral">Lihat Semua <span
                                th:text="${#lists.size(reviews)}"></span> Ulasan</button>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(reviews)}"
                    class="card bg-base-100 shadow-md border border-base-200 mt-8 rounded-2xl">
                    <div class="card-body p-12 text-center">
                        <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        <h3 class="text-xl md:text-2xl font-semibold text-gray-900 mb-2">Belum ada ulasan!</h3>
                        <p class="text-sm md:text-base text-gray-500">Jadilah yang pertama untuk memberikan ulasan.</p>
                    </div>
                </div>

            </div>
        </main>

        <dialog id="adminModal" class="modal">
            <div class="modal-box max-w-xl">

                <h3 class="font-bold text-lg mb-3">Pilih Admin</h3>
                <p class="text-sm text-neutral/70 mb-4">Tentukan admin yang ingin dihubungi:</p>

                <!-- LIST ADMIN -->
                <div id="adminList" class="flex flex-col gap-3">
                    <!-- generated dynamic -->
                </div>

                <div class="modal-action">
                    <button class="btn" id="closeAdminModal">Close</button>
                </div>
            </div>
        </dialog>

    </div>
    <div th:replace="fragment/navbar :: bottombar(${activePage == 'admin'} ? 'admin' : 'products')"></div>

    <script th:src="@{/js/reviewBase.js}"></script>

    <th:block th:if="${!admin}">
        <script th:src="@{/js/productDetail.js}"></script>

    </th:block>
</body>

</html>