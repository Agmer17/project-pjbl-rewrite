<!DOCTYPE html>
<html lang="id" data-theme="light" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - Edit Layanan</title>
    <link rel="stylesheet" th:href="@{/css/output.css}" />
</head>

<body class="font-sans bg-base-200 min-h-screen text-neutral">
    <div th:replace="fragment/navbar :: navbar"></div>

    <div id="toast-container" class="toast toast-top toast-end z-50"></div>

    <dialog id="confirmDeleteModal" class="modal modal-bottom sm:modal-middle">
        <div class="modal-box bg-base-100 shadow-2xl border border-neutral/20 rounded-2xl">
            <h3 class="font-bold text-lg text-error mb-2 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-error" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
                Konfirmasi Penghapusan
            </h3>
            <p class="text-sm text-neutral-content mb-6">
                Apakah kamu yakin ingin menghapus review ini? Tindakan ini tidak bisa dibatalkan.
            </p>

            <div class="modal-action flex flex-col sm:flex-row gap-3 justify-end">
                <button id="confirmDeleteBtn"
                    class="btn btn-error text-white w-full sm:w-auto hover:brightness-110 transition-all">
                    Hapus
                </button>
                <button id="cancelDeleteBtn"
                    class="btn w-full sm:w-auto border-neutral/30 hover:bg-base-200 transition-all">
                    Batal
                </button>
            </div>
        </div>
    </dialog>

    <div class="flex flex-col lg:flex-row mt-16 min-h-screen bg-base-200">

        <th:block th:if="${admin}">
            <div th:replace="fragment/navbar :: sidebar('products')"></div>
        </th:block>


        <main class="w-full max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8 lg:py-12">

            <!-- Back Button -->
            <a th:href="@{${admin} ? '/admin/products/detail/' + ${productId} : '/products/detail/' + ${productId}}"
                class="inline-flex items-center gap-2 mb-6 text-sm font-medium text-neutral hover:text-primary transition-colors group">
                <div
                    class="w-10 h-10 rounded-full border border-neutral group-hover:border-primary flex items-center justify-center transition-all group-hover:scale-110">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7" />
                    </svg>
                </div>
                <span class="text-lg">Kembali ke produk</span>
            </a>

            <!-- Page Header -->
            <div class="mb-8">
                <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-neutral mb-2">Ulasan & Rating</h1>
                <p class="text-sm sm:text-base text-neutral/60">Lihat apa kata pembeli tentang produk ini</p>
            </div>


            <!-- Alert Pending Review yang bisa di-close -->
            <div th:if="${isPending}" x-data="{ open: true }" x-show="open"
                class="alert alert-info shadow-lg mb-6 transition-all duration-300">
                <div class="flex-1 flex items-start sm:items-center gap-2">
                    <!-- Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 w-6 h-6" fill="none"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M12 20a8 8 0 100-16 8 8 0 000 16z" />
                    </svg>
                    <!-- Message -->
                    <span>
                        Review kamu sedang dicek oleh admin. Mohon tunggu beberapa saat sampai review kamu muncul disini
                    </span>
                </div>
            </div>

            <!-- Write Review Form (Only if eligible) -->
            <div th:if="${eligible}" class="mb-8">
                <div
                    class="card bg-gradient-to-br from-primary/5 to-secondary/5 border-2 border-dashed border-primary/30 rounded-3xl">
                    <div class="card-body p-6 sm:p-8">
                        <div class="flex items-start gap-4 mb-6">
                            <div
                                class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0">
                                <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h2 class="text-xl sm:text-2xl font-bold text-neutral mb-1">Tulis Ulasan Kamu</h2>
                                <p class="text-sm text-neutral/70">Bagikan pengalaman kamu dengan produk ini</p>
                            </div>
                        </div>

                        <form id="reviewForm" th:action="@{/reviews/post-review/}" method="POST" class="space-y-6">
                            <input type="hidden" name="productId" th:value="${productId}">

                            <!-- Rating Input -->
                            <div>
                                <label class="block text-sm font-semibold text-neutral mb-3">Rating</label>
                                <div class="flex gap-2">
                                    <input type="radio" name="rating" value="1" class="hidden peer/1" id="star1"
                                        required>
                                    <label for="star1"
                                        class="cursor-pointer text-4xl sm:text-5xl transition-all hover:scale-110 peer-checked/1:text-amber-400 text-neutral/20">★</label>

                                    <input type="radio" name="rating" value="2" class="hidden peer/2" id="star2">
                                    <label for="star2"
                                        class="cursor-pointer text-4xl sm:text-5xl transition-all hover:scale-110 peer-checked/2:text-amber-400 text-neutral/20">★</label>

                                    <input type="radio" name="rating" value="3" class="hidden peer/3" id="star3">
                                    <label for="star3"
                                        class="cursor-pointer text-4xl sm:text-5xl transition-all hover:scale-110 peer-checked/3:text-amber-400 text-neutral/20">★</label>

                                    <input type="radio" name="rating" value="4" class="hidden peer/4" id="star4">
                                    <label for="star4"
                                        class="cursor-pointer text-4xl sm:text-5xl transition-all hover:scale-110 peer-checked/4:text-amber-400 text-neutral/20">★</label>

                                    <input type="radio" name="rating" value="5" class="hidden peer/5" id="star5">
                                    <label for="star5"
                                        class="cursor-pointer text-4xl sm:text-5xl transition-all hover:scale-110 peer-checked/5:text-amber-400 text-neutral/20">★</label>
                                </div>
                            </div>

                            <!-- Review Text -->
                            <div>
                                <label for="textReview" class="block text-sm font-semibold text-neutral mb-2">Ulasan
                                    Kamu</label>
                                <textarea id="textReview" name="textReview" rows="5" required maxlength="500"
                                    placeholder="Ceritakan pengalaman kamu dengan produk ini..."
                                    class="textarea textarea-bordered w-full bg-base-100 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 resize-none text-base rounded-2xl"></textarea>
                                <div class="flex justify-end mt-2">
                                    <span id="charCount" class="text-xs text-neutral/50">0/500</span>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <div class="flex flex-col sm:flex-row gap-3 pt-2">
                                <button type="submit"
                                    class="btn btn-primary text-white flex-1 sm:flex-none rounded-full p-2 hover:shadow-lg hover:scale-105 transition-all">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                    </svg>
                                    Kirim Ulasan
                                </button>
                                <button type="reset" class="btn btn-ghost rounded-full px-8 hover:bg-base-200">
                                    Batal
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Sort Dropdown -->
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-neutral/60" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" />
                    </svg>
                    <select id="sortReviews"
                        class="select select-bordered select-sm sm:select-md rounded-full bg-base-100 border-neutral/20 focus:border-primary focus:outline-none">
                        <option value="newest">Terbaru</option>
                        <option value="highest">Rating Tertinggi</option>
                        <option value="lowest">Rating Terendah</option>
                    </select>
                </div>
            </div>

            <!-- Rating Summary Card -->
            <div th:with="totalReviews=${reviews.size()}">
                <div
                    class="card bg-gradient-to-br from-base-100 to-base-200/50 shadow-xl border border-base-300 mb-8 rounded-3xl overflow-hidden">
                    <div class="card-body p-6 sm:p-8 lg:p-10">
                        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 lg:gap-8">

                            <!-- Average Rating -->
                            <div
                                class="lg:col-span-2 flex flex-col items-center lg:items-start justify-center border-b lg:border-b-0 lg:border-r border-base-300 pb-6 lg:pb-0 lg:pr-8">
                                <div class="text-6xl sm:text-7xl lg:text-8xl font-black text-neutral mb-3 tracking-tight"
                                    th:text="${#numbers.formatDecimal(avg,1,1)}">4.8</div>
                                <div class="flex items-center gap-1 mb-3">
                                    <span th:each="i : ${#numbers.sequence(1,5)}"
                                        th:classappend="${avg >= i ? 'text-amber-400' : 'text-neutral/20'}"
                                        class="text-3xl sm:text-4xl">★</span>
                                </div>
                                <div class="text-base sm:text-lg text-neutral/70 font-medium"
                                    th:text="${totalReviews} + ' ulasan'">286 ulasan</div>
                            </div>

                            <!-- Rating Distribution -->
                            <div class="lg:col-span-3 space-y-3 sm:space-y-4">
                                <div th:each="ratingLevel : ${#numbers.sequence(5,1)}"
                                    th:with="count=${reviewRatingCount.get(ratingLevel) ?: 0L}">
                                    <div
                                        class="flex items-center gap-3 sm:gap-4 group hover:bg-base-200/50 p-2 rounded-xl transition-all">
                                        <span class="text-sm sm:text-base font-semibold text-neutral w-3 text-right"
                                            th:text="${ratingLevel}">5</span>
                                        <span class="text-amber-400 text-base sm:text-lg">★</span>
                                        <div class="flex-1 bg-base-300 rounded-full h-2.5 sm:h-3 overflow-hidden">
                                            <div class="bg-gradient-to-r from-amber-400 to-amber-500 h-full rounded-full transition-all duration-500 group-hover:shadow-lg"
                                                th:style="'width: ' + (${totalReviews} > 0 ? ${count * 100.0 / totalReviews} : 0) + '%'">
                                            </div>
                                        </div>
                                        <span
                                            class="text-sm sm:text-base text-neutral/70 font-medium w-10 sm:w-12 text-right"
                                            th:text="${count}">100</span>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <!-- Reviews List -->
            <div class="space-y-4 sm:space-y-5" id="reviewsList">
                <div th:each="review : ${reviews}"
                    class="card bg-base-100 shadow-md border border-base-200 hover:shadow-xl hover:border-primary/20 transition-all duration-300 rounded-2xl">
                    <div class="card-body p-5 sm:p-6 lg:p-8">
                        <div class="flex items-start gap-3 sm:gap-4">

                            <!-- Avatar -->
                            <div class="avatar placeholder flex-shrink-0">
                                <div class="w-11 h-11 sm:w-12 sm:h-12 rounded-full overflow-hidden ring-2 ring-base-300"
                                    th:classappend="${review.user.profilePicture == null ? 'bg-gradient-to-br from-primary to-secondary text-white flex items-center justify-center' : ''}">
                                    <img th:if="${review.user.profilePicture != null}"
                                        th:src="@{'/uploads/' + ${review.user.profilePicture}}" alt="User photo"
                                        class="w-full h-full object-cover" />
                                    <span th:if="${review.user.profilePicture == null}"
                                        class="text-lg sm:text-xl font-bold"
                                        th:text="${review.user.fullName != null ? #strings.substring(review.user.fullName,0,1) : 'U'}">A</span>
                                </div>
                            </div>

                            <!-- Content -->
                            <div class="flex-1 min-w-0">
                                <div
                                    class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2 sm:gap-4 mb-3">
                                    <div class="flex-1 min-w-0">
                                        <h3 class="font-bold text-neutral text-base sm:text-lg truncate"
                                            th:text="${review.user.fullName}">Astolfo</h3>
                                        <p class="text-xs sm:text-sm text-neutral/50 flex items-center gap-1.5 mt-0.5">
                                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                            <span th:text="${#temporals.format(review.createdAt, 'dd MMM yyyy')}">04 Nov
                                                2025</span>
                                        </p>
                                    </div>

                                    <!-- Delete Button (Admin only) -->
                                    <button th:if="${admin}"
                                        class="btn btn-ghost btn-sm text-error hover:bg-error/10 rounded-full px-3 sm:px-4 flex items-center gap-1.5 flex-shrink-0 transition-all hover:scale-105"
                                        th:attr="data-id=${review.id}" onclick="deleteReview(this)">
                                        <svg class="w-4 h-4" viewBox="0 0 448 512" fill="currentColor">
                                            <path
                                                d="M432 80h-82.38l-34-56.75C306.1 8.827 291.4 0 274.6 0H173.4C156.6 0 141 8.827 132.4 23.25L98.38 80H16C7.125 80 0 87.13 0 96v16C0 120.9 7.125 128 16 128H32v320c0 35.35 28.65 64 64 64h256c35.35 0 64-28.65 64-64V128h16C440.9 128 448 120.9 448 112V96C448 87.13 440.9 80 432 80zM171.9 50.88C172.9 49.13 174.9 48 177 48h94c2.125 0 4.125 1.125 5.125 2.875L293.6 80H154.4L171.9 50.88zM352 464H96c-8.837 0-16-7.163-16-16V128h288v320C368 456.8 360.8 464 352 464zM224 416c8.844 0 16-7.156 16-16V192c0-8.844-7.156-16-16-16S208 183.2 208 192v208C208 408.8 215.2 416 224 416zM144 416C152.8 416 160 408.8 160 400V192c0-8.844-7.156-16-16-16S128 183.2 128 192v208C128 408.8 135.2 416 144 416zM304 416c8.844 0 16-7.156 16-16V192c0-8.844-7.156-16-16-16S288 183.2 288 192v208C288 408.8 295.2 416 304 416z" />
                                        </svg>
                                        <span class="hidden sm:inline font-medium">Hapus</span>
                                    </button>
                                </div>

                                <!-- Rating Stars -->
                                <div class="flex items-center gap-1.5 mb-3">
                                    <div class="flex items-center gap-0.5">
                                        <span th:each="i : ${#numbers.sequence(1,5)}"
                                            th:classappend="${review.rating >= i ? 'text-amber-400' : 'text-neutral/20'}"
                                            class="text-xl sm:text-2xl">★</span>
                                    </div>
                                    <span class="text-sm sm:text-base font-bold text-neutral ml-1"
                                        th:text="${#numbers.formatDecimal(review.rating,1,1)}">4.0</span>
                                </div>

                                <!-- Review Text -->
                                <p class="text-neutral/80 leading-relaxed text-sm sm:text-base mb-4"
                                    th:text="${review.textReview}">
                                    Lumayan bagus tapi pengiriman agak lama, semoga lebih cepat next time.
                                </p>

                                <!-- Status Badge -->
                                <div th:switch="${review.status}">
                                    <span th:case="'APPROVED'"
                                        class="badge badge-success gap-1.5 px-3 py-2.5 rounded-full">
                                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd"
                                                d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" />
                                        </svg>
                                        Disetujui
                                    </span>
                                    <span th:case="'PENDING'"
                                        class="badge badge-warning gap-1.5 px-3 py-2.5 rounded-full">
                                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd"
                                                d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" />
                                        </svg>
                                        Menunggu
                                    </span>
                                    <span th:case="'REJECTED'"
                                        class="badge badge-error gap-1.5 px-3 py-2.5 rounded-full">
                                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd"
                                                d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" />
                                        </svg>
                                        Ditolak
                                    </span>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div th:if="${#lists.isEmpty(reviews)}"
                class="card bg-base-100 shadow-lg border-2 border-dashed border-base-300 mt-8 rounded-3xl">
                <div class="card-body p-12 sm:p-16 text-center">
                    <div
                        class="w-20 h-20 sm:w-24 sm:h-24 mx-auto mb-6 rounded-full bg-primary/10 flex items-center justify-center">
                        <svg class="w-10 h-10 sm:w-12 sm:h-12 text-primary" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                        </svg>
                    </div>
                    <h3 class="text-xl sm:text-2xl lg:text-3xl font-bold text-neutral mb-3">Belum ada ulasan</h3>
                    <p class="text-sm sm:text-base text-neutral/60 max-w-md mx-auto">Jadilah yang pertama membagikan
                        pengalaman kamu dengan produk ini!</p>
                </div>
            </div>

        </main>
    </div>

    <script th:src="@{/js/reviewBase.js}"></script>
</body>

</html>